From 3174ea50f822eb63797776d7be1ae4418163c724 Mon Sep 17 00:00:00 2001
From: Dirkjan Ochtman <dirkjan@ochtman.nl>
Date: Tue, 8 Dec 2020 17:17:37 +0100
Subject: [PATCH] url: fix panic on popping from Url without path (fixes #656)

---
 url/src/path_segments.rs | 6 ++++++
 url/tests/unit.rs        | 8 ++++++++
 2 files changed, 14 insertions(+)

diff --git a/url/src/path_segments.rs b/url/src/path_segments.rs
index f2ae67e..29afc1e 100644
--- a/url/src/path_segments.rs
+++ b/url/src/path_segments.rs
@@ -123,6 +123,9 @@ impl<'a> PathSegmentsMut<'a> {
     /// # run().unwrap();
     /// ```
     pub fn pop_if_empty(&mut self) -> &mut Self {
+        if self.after_first_slash >= self.url.serialization.len() {
+            return self;
+        }
         if self.url.serialization[self.after_first_slash..].ends_with('/') {
             self.url.serialization.pop();
         }
@@ -135,6 +138,9 @@ impl<'a> PathSegmentsMut<'a> {
     ///
     /// Returns `&mut Self` so that method calls can be chained.
     pub fn pop(&mut self) -> &mut Self {
+        if self.after_first_slash >= self.url.serialization.len() {
+            return self;
+        }
         let last_slash = self.url.serialization[self.after_first_slash..]
             .rfind('/')
             .unwrap_or(0);
diff --git a/url/tests/unit.rs b/url/tests/unit.rs
index 19ac8d1..4c25198 100644
--- a/url/tests/unit.rs
+++ b/url/tests/unit.rs
@@ -671,3 +671,11 @@ fn no_panic() {
     let mut url = Url::parse("arhttpsps:/.//eom/dae.com/\\\\t\\:").unwrap();
     url::quirks::set_hostname(&mut url, "//eom/datcom/\\\\t\\://eom/data.cs").unwrap();
 }
+
+#[test]
+fn pop_if_empty_in_bounds() {
+    let mut url = Url::parse("m://").unwrap();
+    let mut segments = url.path_segments_mut().unwrap();
+    segments.pop_if_empty();
+    segments.pop();
+}
-- 
2.42.0.windows.2

