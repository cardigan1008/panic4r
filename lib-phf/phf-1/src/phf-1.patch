From 83fd51c3095cbcd22b87c4d26ee22eb27a4e98d0 Mon Sep 17 00:00:00 2001
From: cetra3 <peter@parashift.com.au>
Date: Mon, 18 Mar 2019 15:38:24 +1030
Subject: [PATCH] Fix & include tests for empty maps

---
 phf/src/map.rs              |  1 +
 phf/src/ordered_map.rs      |  1 +
 phf_codegen/test/build.rs   |  9 +++++++++
 phf_codegen/test/src/lib.rs | 11 +++++++++++
 4 files changed, 22 insertions(+)

diff --git a/phf/src/map.rs b/phf/src/map.rs
index f8046af..efabf31 100644
--- a/phf/src/map.rs
+++ b/phf/src/map.rs
@@ -80,6 +80,7 @@ impl<K, V> Map<K, V> {
         where T: Eq + PhfHash,
               K: Borrow<T>
     {
+        if self.disps.len() == 0 { return None; } //Prevent panic on empty map
         let hash = phf_shared::hash(key, self.key);
         let index = phf_shared::get_index(hash, &*self.disps, self.entries.len());
         let entry = &self.entries[index as usize];
diff --git a/phf/src/ordered_map.rs b/phf/src/ordered_map.rs
index cd1d552..82567a6 100644
--- a/phf/src/ordered_map.rs
+++ b/phf/src/ordered_map.rs
@@ -108,6 +108,7 @@ impl<K, V> OrderedMap<K, V> {
         where T: Eq + PhfHash,
               K: Borrow<T>
     {
+        if self.disps.len() == 0 { return None; } //Prevent panic on empty map
         let hash = phf_shared::hash(key, self.key);
         let idx_index = phf_shared::get_index(hash, &*self.disps, self.idxs.len());
         let idx = self.idxs[idx_index as usize];
diff --git a/phf_codegen/test/build.rs b/phf_codegen/test/build.rs
index 49b5a9a..f45edad 100644
--- a/phf_codegen/test/build.rs
+++ b/phf_codegen/test/build.rs
@@ -65,4 +65,13 @@ fn main() {
         .build(&mut file)
         .unwrap();
     write!(&mut file, ";\n").unwrap();
+
+    //u32 is used here purely for a type that impls `Hash+PhfHash+Eq+fmt::Debug`, but is not required for the empty test itself
+    write!(&mut file, "static EMPTY: ::phf::Map<u32, u32> = ").unwrap();
+    phf_codegen::Map::<u32>::new().build(&mut file).unwrap();
+    write!(&mut file, ";\n").unwrap();
+
+    write!(&mut file, "static EMPTY_ORDERED: ::phf::OrderedMap<u32, u32> = ").unwrap();
+    phf_codegen::OrderedMap::<u32>::new().build(&mut file).unwrap();
+    write!(&mut file, ";\n").unwrap();
 }
diff --git a/phf_codegen/test/src/lib.rs b/phf_codegen/test/src/lib.rs
index a5aeeee..d1944dd 100644
--- a/phf_codegen/test/src/lib.rs
+++ b/phf_codegen/test/src/lib.rs
@@ -55,4 +55,15 @@ mod test {
         assert_eq!("b", UNICASE_MAP[&UniCase("DEf")]);
         assert!(!UNICASE_MAP.contains_key(&UniCase("XyZ")));
     }
+
+     #[test]
+    fn empty_map() {
+        assert_eq!(None, EMPTY.get(&1));
+    }
+
+     #[test]
+    fn empty_ordered_map() {
+        assert_eq!(None, EMPTY_ORDERED.get(&1));
+    }
+
 }
-- 
2.25.1

